import customtkinter as ctk
import requests, zipfile, io, os, threading, sys, platform, subprocess, logging, json

# ---- WINDOWS KONTROLÜ ----
if platform.system() != "Windows":
    raise SystemExit("This launcher is Windows-only.")

# ---- SABİTLER ----
APP_NAME = "Infinite Dash Runner"
VERSION_URL = "https://raw.githubusercontent.com/FahrettinPasha/Infinite-Dash-Runner-Pygame/main/version.json"

BASE_DIR = os.path.join(os.getenv("APPDATA"), "PashaGames", "InfiniteDash")
GAME_DIR = os.path.join(BASE_DIR, "game")
VERSION_FILE = os.path.join(BASE_DIR, "version.txt")
LOG_FILE = os.path.join(BASE_DIR, "install.log")

GAME_FOLDER_NAME = "Infinite-Dash-Runner-Pygame-main"
GAME_MAIN = os.path.join(GAME_DIR, GAME_FOLDER_NAME, "main.py")

os.makedirs(GAME_DIR, exist_ok=True)

logging.basicConfig(filename=LOG_FILE, level=logging.ERROR)

# ---- LAUNCHER ----
class Launcher(ctk.CTk):
    def __init__(self):
        super().__init__()
        self.title(APP_NAME)
        self.geometry("520x420")

        self.title_lbl = ctk.CTkLabel(self, text=APP_NAME, font=("Arial", 26, "bold"))
        self.title_lbl.pack(pady=30)

        self.status = ctk.CTkLabel(self, text="Hazır", text_color="white")
        self.status.pack(pady=10)

        self.progress = ctk.CTkProgressBar(self, width=420)
        self.progress.set(0)
        self.progress.pack(pady=20)

        self.btn = ctk.CTkButton(
            self,
            text="OYUNU BAŞLAT",
            width=260,
            height=60,
            font=("Arial", 16, "bold"),
            command=self.start
        )
        self.btn.pack(pady=30)

    # ---- UI SAFE ----
    def ui(self, text, color="white", value=None):
        self.after(0, lambda: self.status.configure(text=text, text_color=color))
        if value is not None:
            self.after(0, lambda: self.progress.set(value))

    def start(self):
        self.btn.configure(state="disabled")
        threading.Thread(target=self.run, daemon=True).start()

    def run(self):
        try:
            self.check_update()
            self.launch_game()
        except Exception as e:
            logging.error(str(e))
            self.ui("Hata oluştu. install.log kontrol edin.", "red")
        finally:
            self.after(0, lambda: self.btn.configure(state="normal"))

    # ---- UPDATE SYSTEM ----
    def check_update(self):
        self.ui("Güncellemeler kontrol ediliyor...", "yellow", 0.1)

        r = requests.get(VERSION_URL, timeout=15)
        if r.status_code != 200:
            raise Exception("Version check failed")

        data = r.json()
        remote_version = data["version"]
        zip_url = data["zip_url"]

        local_version = "0.0.0"
        if os.path.exists(VERSION_FILE):
            with open(VERSION_FILE, "r") as f:
                local_version = f.read().strip()

        if remote_version != local_version:
            self.download_update(zip_url, remote_version)
        else:
            self.ui("Oyun güncel", "green", 0.3)

    def download_update(self, url, version):
        self.ui("Güncelleme indiriliyor...", "orange", 0.4)

        r = requests.get(url, timeout=30)
        if r.status_code != 200:
            raise Exception("Download failed")

        self.ui("Kuruluyor...", "cyan", 0.7)

        if os.path.exists(GAME_DIR):
            for root, dirs, files in os.walk(GAME_DIR):
                for file in files:
                    os.remove(os.path.join(root, file))

        with zipfile.ZipFile(io.BytesIO(r.content)) as z:
            z.extractall(GAME_DIR)

        with open(VERSION_FILE, "w") as f:
            f.write(version)

        self.ui("Güncelleme tamamlandı", "green", 1.0)

    # ---- GAME LAUNCH ----
    def launch_game(self):
        if not os.path.exists(GAME_MAIN):
            raise Exception("Game not found")

        self.ui("Oyun başlatılıyor...", "green", 1.0)
        subprocess.Popen([sys.executable, GAME_MAIN], cwd=os.path.dirname(GAME_MAIN))
        self.after(1500, self.destroy)

# ---- RUN ----
if __name__ == "__main__":
    app = Launcher()
    app.mainloop()
